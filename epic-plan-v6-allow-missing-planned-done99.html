<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport"/>
<title>Epic Plan (v6 – Full) • % Overlay + Precise Alignment v5.1.3 (Rows + Guides • Fix#62 • Parity++ )</title>
<script crossorigin="" src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin="" src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/htm@3.1.1/dist/htm.umd.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&amp;display=swap" rel="stylesheet"/>
<style>
  :root { --bg:#0f1218; --panel:#141925; --muted:#9aa4b2; --text:#e8edf3; --grid:#1f2735; --accent:#5b8cff; --danger:#ff6b6b; --priority-high:#ff4d4f; --priority-medium:#f7b955; --priority-low:#57c9a5; --eta-color:#ff77e1; --today-color:#ffed4a; --row-height:36px; --row-gap:8px; --left-width:340px; --header-height:64px; --label-font:13px; }
  *{box-sizing:border-box} html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  .app{display:grid;grid-template-rows:var(--header-height) 1fr;height:100vh}
  .topbar{display:grid;grid-template-columns:1fr auto auto auto;gap:8px;align-items:center;padding:8px 12px;border-bottom:1px solid var(--grid);background:linear-gradient(180deg,#121725 0%,#0f1218 100%);position:sticky;top:0;z-index:10}
  .title{font-weight:600;font-size:18px;padding:6px 10px;border-radius:6px;outline:none;border:1px dashed transparent}
  .title[contenteditable="true"]:focus{border-color:var(--accent);background:#0e1524}
  .toolbar{display:flex;align-items:center;gap:8px}
  .btn{background:#141a2a;color:var(--text);border:1px solid var(--grid);padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:500}
  .btn:hover{border-color:var(--accent)} .btn.primary{background:linear-gradient(180deg,#3a6cff 0%,#2a50c3 100%);border-color:#183a9e}
  .btn.danger{background:#2a1517;border-color:#4a2428;color:#ffb3b6}
  input,select{background:#0e1524;color:var(--text);border:1px solid var(--grid);border-radius:6px;padding:6px 8px}
  label{color:var(--muted);font-size:12px}

  .layout{display:grid;grid-template-columns:var(--left-width) 1fr;height:calc(100vh - var(--header-height))}
  .left-panel{border-right:1px solid var(--grid);display:flex;flex-direction:column;min-height:0}
  .right-panel{overflow:auto;position:relative}
  .header-row{display:grid;grid-template-columns:var(--left-width) 1fr;position:sticky;top:0;z-index:5;background:#0f131d;border-bottom:1px solid var(--grid)}
  .left-header,.right-header{padding:10px;font-weight:600;color:var(--muted)}

  .legend{display:flex;gap:12px;flex-wrap:wrap;padding:8px 10px;border-bottom:1px dashed var(--grid);background:#0c1323}
  .legend>div{display:flex;align-items:center;gap:6px}
  .swatch{width:14px;height:14px;border-radius:3px;border:1px solid var(--grid)}
  .diamond{width:12px;height:12px;transform:rotate(45deg);border:1px solid var(--grid);background:var(--eta-color)}

  .left-list{flex:1 1 auto; min-height:0; padding:8px; overflow:auto; position:relative; will-change:auto; scrollbar-width:none} .left-list::-webkit-scrollbar{display:none}
  .left-top-spacer{height:0}
  .left-bottom-spacer{height:0}
  .epic-row{display:grid;grid-template-columns:28px 96px 1fr;align-items:center;gap:8px;height:var(--row-height);margin-bottom:var(--row-gap);padding:0 6px;border-radius:8px;position:relative}
  .epic-row:hover{background:rgba(255,255,255,0.03)}
  .hide-btn{width:24px;height:24px;display:grid;place-items:center;border:1px solid var(--grid);border-radius:6px;background:#0e1524;color:#9aa4b2;cursor:pointer}
  .epic-key{font-weight:600;color:#d8deeb;font-size:var(--label-font);padding:4px 6px;border-radius:6px;background:#0e1524;border:1px solid var(--grid);text-align:center}
  .epic-summary{color:#e8edf3;font-size:var(--label-font);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .context-actions{position:absolute;right:8px;top:50%;transform:translateY(-50%);display:none;gap:6px}
  .epic-row:hover .context-actions{display:flex}

  .sprint-labels{position:sticky;top:0;z-index:4;background:linear-gradient(180deg,rgba(15,19,29,.95),rgba(15,19,29,.75));border-bottom:1px dashed var(--grid)}
  .right-canvas{position:relative;padding:8px 12px 24px 12px;min-width:900px}
  .grid-svg{display:block}

  .guides-overlay{position:absolute;inset:0;pointer-events:none}
  .guide-line{position:absolute;left:0;right:0;height:0;border-top:1px dashed #2a3450;opacity:.5}

  ::-webkit-scrollbar{height:10px;width:10px}::-webkit-scrollbar-track{background:#0f1522}::-webkit-scrollbar-thumb{background:#1e2a43;border-radius:6px}::-webkit-scrollbar-thumb:hover{background:#273759}

/* --- Hidden Drawer (CSS-only overlay) --- */
/* .hidden-panel{ position:fixed; inset:0; z-index:1999; padding-left:calc(100vw - 480px); overflow:auto; }
.hidden-panel::before{ content:''; position:fixed; inset:0; background:rgba(0,0,0,0.45); backdrop-filter:blur(1px); }
.hidden-panel > .drawer-header{ position:sticky; top:0; z-index:1; background:#0f131d; border-bottom:1px solid var(--grid); padding:10px 12px; }
.hidden-panel > div:not(.drawer-header){ background:#0f1628; border-left:1px solid var(--grid); box-shadow:-12px 0 24px rgba(0,0,0,0.35); padding:12px; min-height:100%; }
.hidden-item{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding:8px 10px; border:1px solid var(--grid); border-radius:8px; background:#0e1524; }

/* --- Settings Drawer (overlay + sheet) --- */
.settings-drawer{ position:fixed; inset:0; z-index:2000; }
.settings-drawer .backdrop{ position:absolute; inset:0; background:rgba(0,0,0,0.45); backdrop-filter:blur(1px); }
.settings-drawer .settings-sheet{ position:absolute; top:0; right:0; bottom:0; width:480px; max-width:calc(100vw - 40px); background:#0f1628; border-left:1px solid var(--grid); box-shadow:-12px 0 24px rgba(0,0,0,0.35); display:flex; flex-direction:column; animation:sheet-in 180ms ease-out both; }
@keyframes sheet-in{ from{ transform:translateX(24px); opacity:0.92; } to{ transform:translateX(0); opacity:1; } }
.drawer-header{ display:flex; align-items:center; justify-content:space-between; padding:10px 12px; background:#0f131d; border-bottom:1px solid var(--grid); position:sticky; top:0; z-index:1; }
.drawer-body{ padding:12px; overflow:auto; display:grid; gap:12px; }
.drawer-body .row{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
@media (max-width:680px){ .drawer-body .row{ grid-template-columns:1fr; } }

/* --- Hidden Drawer (overlay + sheet) --- */
.hidden-drawer{ position:fixed; inset:0; z-index:1999; }
.hidden-drawer .backdrop{ position:absolute; inset:0; background:rgba(0,0,0,0.45); backdrop-filter:blur(1px); }
.hidden-drawer .hidden-sheet{ position:absolute; top:0; right:0; bottom:0; width:480px; max-width:calc(100vw - 40px); background:#0f1628; border-left:1px solid var(--grid); box-shadow:-12px 0 24px rgba(0,0,0,0.35); display:flex; flex-direction:column; animation:sheet-in 180ms ease-out both; }
.hidden-sheet .drawer-header{ display:flex; align-items:center; justify-content:space-between; padding:10px 12px; background:#0f131d; border-bottom:1px solid var(--grid); position:sticky; top:0; z-index:1; }
.hidden-sheet .drawer-body{ padding:12px; overflow:auto; display:grid; gap:10px; }
.hidden-item{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding:8px 10px; border:1px solid var(--grid); border-radius:8px; background:#0e1524; }
@keyframes sheet-in{ from{ transform:translateX(24px); opacity:0.92; } to{ transform:translateX(0); opacity:1; } }

.hidden-drawer .hidden-sheet{ z-index:1; }
.settings-drawer .settings-sheet{ z-index:1; }

.hidden-drawer .hidden-sheet{ z-index:1; }

  .toast{ position:fixed; right:16px; bottom:16px; background:#0f1628; border:1px solid var(--grid); color:var(--text); padding:8px 12px; border-radius:8px; z-index:5000; box-shadow:0 8px 24px rgba(0,0,0,0.35); }

  .context-actions.right{ display:flex; gap:6px; justify-content:flex-end; }
  .context-actions.right .small-btn{ padding:4px 8px; }

  /* --- Modern action buttons (3D-ish) --- */
  .act-btn{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:10px;border:1px solid rgba(255,255,255,0.12);font-weight:600;cursor:pointer;user-select:none;
    background:linear-gradient(180deg, rgba(255,255,255,0.06), rgba(0,0,0,0.20));
    box-shadow: inset 0 1px 0 rgba(255,255,255,0.06), 0 6px 16px rgba(0,0,0,0.35), 0 1px 0 rgba(255,255,255,0.05);
    color:#e8edf3; transition:transform 120ms ease, box-shadow 120ms ease, border-color 120ms ease, background 120ms ease; backdrop-filter: blur(2px);
  }
  .act-btn svg{display:block}
  .act-btn:hover{transform:translateY(-1px); box-shadow: inset 0 1px 0 rgba(255,255,255,0.08), 0 10px 22px rgba(0,0,0,0.45)}
  .act-btn:active{transform:translateY(0); box-shadow: inset 0 2px 4px rgba(0,0,0,0.35), 0 3px 8px rgba(0,0,0,0.35)}
  .act-btn.edit{ color:#dbe2f0; border-color:#2b3854; background:linear-gradient(180deg, #253147, #1b2436); }
  .act-btn.edit:hover{ border-color:#47629d; background:linear-gradient(180deg, #2f3f5c, #1c2840); }
  .act-btn.remove{ color:#ffe7ea; border-color:#5a1c23; background:linear-gradient(180deg, #8b1e2a, #4a0f15); }
  .act-btn.remove:hover{ border-color:#ae3340; background:linear-gradient(180deg, #a52331, #5a1219); }
  .context-actions.right{ display:flex; gap:8px; justify-content:flex-end; align-items:center; }

</style>
<style>
.contextual-actions {
  position: absolute;
  right: 0;
  top: 0;
  display: none;
  z-index: 10;
}
.gantt-row:hover .contextual-actions {
  display: block;
}
.date-marker {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background-color: #333;
  position: absolute;
}
</style></head>
<body>
<div id="root"></div>
<script>
const {useState,useMemo,useRef,useEffect,useLayoutEffect}=React;const html=htm.bind(React.createElement);
function parseYMD(ymd){if(!ymd)return null;const [y,m,d]=ymd.split('-').map(Number);if(!y||!m||!d)return null;return new Date(y,m-1,d)}
function fmtYMD(d){if(!d)return'';const y=d.getFullYear();const m=String(d.getMonth()+1).padStart(2,'0');const day=String(d.getDate()).padStart(2,'0');return `${y}-${m}-${day}`}
function fmtDDMMM(d){if(!d)return'';const months=['JAN','FEB','MAR','APR','MAY','JUN','JUL','AUG','SEP','OCT','NOV','DEC'];const dd=String(d.getDate()).padStart(2,'0');const mon=months[d.getMonth()];return `${dd}-${mon}`}
function clamp(n,min,max){return Math.max(min,Math.min(max,n))}
function daysBetween(a,b){const ms=(parseYMD(fmtYMD(b))-parseYMD(fmtYMD(a)))/86400000;return Math.round(ms)}
function addDays(d,days){return new Date(d.getFullYear(),d.getMonth(),d.getDate()+days)}
function uid(){return Math.random().toString(36).slice(2,9)}
function hexToRGBA(hex,alpha=0.5){if(!hex)return`rgba(0,0,0,${alpha})`;hex=hex.replace('#','');if(hex.length===3){const r=parseInt(hex[0]+hex[0],16),g=parseInt(hex[1]+hex[1],16),b=parseInt(hex[2]+hex[2],16);return`rgba(${r},${g},${b},${alpha})`}else{const r=parseInt(hex.slice(0,2),16),g=parseInt(hex.slice(2,4),16),b=parseInt(hex.slice(4,6),16);return`rgba(${r},${g},${b},${alpha})`}}
function isDone(epic){ return Number(epic.percentComplete) > 99; }
function parseCSV(t){const rows=[];let i=0,f='',r=[],q=false;while(i<t.length){const c=t[i];if(q){if(c=='"'){if(t[i+1]=='"'){f+='"';i++;}else q=false;}else f+=c;}else{if(c=='"')q=true;else if(c==','){r.push(f);f='';}else if(c=='\n'){r.push(f);rows.push(r);r=[];f='';}else if(c=='\r'){}else f+=c;}i++;}if(f.length||r.length){r.push(f);rows.push(r)}return rows}
function toCSV(rows){const esc=v=>{if(v==null)return'';const s=String(v);if(/[",\n]/.test(s))return '"'+s.replace(/"/g,'""')+'"';return s};return rows.map(r=>r.map(esc).join(',')).join('\n')}

function App(){
  const DEFAULT_TITLE='Epic Plan (v6 – Full) • % Overlay + Precise Alignment v5.1.3 (Rows + Guides • Fix#62 • Parity++ )';
  const [title,setTitle]=useState(()=>localStorage.getItem('ep_title')||DEFAULT_TITLE);
  const [epics,setEpics]=useState(()=>{const saved=localStorage.getItem('ep_data');if(saved){try{return JSON.parse(saved)}catch(e){}}return[
    {id:uid(),key:'EP-101',summary:'Foundational platform setup',priority:'High',plannedStart:'2025-10-01',plannedEnd:'2025-11-12',actualStart:'2025-10-03',actualEnd:'',percentComplete:35,eta:'2025-11-08',hidden:false},
    {id:uid(),key:'EP-102',summary:'Payments integration',priority:'Medium',plannedStart:'2025-10-15',plannedEnd:'2025-12-10',actualStart:'',actualEnd:'',percentComplete:10,eta:'2025-12-05',hidden:false},
    {id:uid(),key:'EP-103',summary:'Mobile app MVP',priority:'Low',plannedStart:'2025-10-20',plannedEnd:'2025-11-25',actualStart:'2025-10-21',actualEnd:'2025-11-20',percentComplete:100,eta:'2025-11-18',hidden:false},
  ]});
  const [settings,setSettings]=useState(()=>{const saved=localStorage.getItem('ep_settings');if(saved){try{return JSON.parse(saved)}catch(e){}}return{
    projectStart:'2025-10-01',projectEnd:'2025-12-31',sprintWeeks:2,showToday:true,dayWidth:22,
    priorityColors:{High:'#ff4d4f',Medium:'#f7b955',Low:'#57c9a5'},
    overlayColor:'#5b8cff',overlayAlpha:0.35,
    completionOverlayColor:'#2cc38a',completionOverlayAlpha:0.45,
    etaColor:'#ff77e1',percentTextColor:'#ffffff',
    showGuides:false,
    rowHeight:36, linkLabelFont:true,
  }});

  const [drawerOpen,setDrawerOpen]=useState(false);
  const [hiddenOpen,setHiddenOpen]=useState(false);
  const [editing,setEditing]=useState(null);
  const [hoveredEpicId,setHoveredEpicId]=useState(null);
  const [vpRight,setVpRight]=useState(0);
  useEffect(()=>{
    const rp=rightPanelRef.current; if(!rp) return;
    const update=()=> setVpRight((rp.scrollLeft||0) + (rp.clientWidth||0) - 170 - 12);
    update();
    rp.addEventListener('scroll', update, {passive:true});
    const ro=new ResizeObserver(update); ro.observe(rp);
    return ()=>{ rp.removeEventListener('scroll', update); ro.disconnect(); };
  },[]);

  const [toast,setToast]=useState(null); const toastTimerRef=useRef(0);
  function showToast(msg){ try{ if(toastTimerRef.current) clearTimeout(toastTimerRef.current); }catch(e){} setToast(msg); toastTimerRef.current=setTimeout(()=>setToast(null),2000); }

  const rightPanelRef=useRef(null); const leftListRef=useRef(null); const legendRef=useRef(null); const sprintLabelsRef=useRef(null); const rightCanvasRef=useRef(null);

  // Apply CSS vars when row height / label scaling changes
  useEffect(()=>{
    const root=document.documentElement; root.style.setProperty('--row-height', (settings.rowHeight||36)+'px');
    const base=13; let f=base; if(settings.linkLabelFont){ f=Math.max(11, Math.round(base*(settings.rowHeight||36)/36)); }
    root.style.setProperty('--label-font', f+'px');
  },[settings.rowHeight, settings.linkLabelFont]);

  // Two-way vertical scroll sync (left ⇄ right) with loop guard
  useEffect(()=>{
    const rp = rightPanelRef.current, ll = leftListRef.current; if(!rp||!ll) return;
    const state = { from: null };
    const onRight = () => { if(state.from==='left') return; state.from='right'; if(ll.scrollTop!==rp.scrollTop) ll.scrollTop = rp.scrollTop; requestAnimationFrame(()=>{ state.from=null; }); };
    const onLeft  = () => { if(state.from==='right') return; state.from='left'; if(rp.scrollTop!==ll.scrollTop) rp.scrollTop = ll.scrollTop; requestAnimationFrame(()=>{ state.from=null; }); };
    rp.addEventListener('scroll', onRight, { passive:true });
    ll.addEventListener('scroll', onLeft,  { passive:true });
    // initial align from right as source of truth
    ll.scrollTop = rp.scrollTop;
    return ()=>{ rp.removeEventListener('scroll', onRight); ll.removeEventListener('scroll', onLeft); };
  },[]);

  // Range parity via ResizeObserver (keep scrollable ranges equal)
  const spacersRef = useRef({top:0,bottom:0});
  useEffect(()=>{ spacersRef.current = spacers; });
  useEffect(()=>{ const rp=rightPanelRef.current, ll=leftListRef.current; if(!rp||!ll) return; const compute=()=>{
    const leftTotal=ll.scrollHeight||0, rightTotal=rp.scrollHeight||0;
    const leftClient=ll.clientHeight||0, rightClient=rp.clientHeight||0;
    const leftRange=Math.max(0,leftTotal-leftClient), rightRange=Math.max(0,rightTotal-rightClient);
    const currentBottom=spacersRef.current.bottom||0;
    const desiredBottom=Math.max(0,currentBottom + (rightRange-leftRange));
    if (Math.abs(desiredBottom-currentBottom)>0.5){ setSpacers(prev=>({...prev,bottom:desiredBottom})); }
  }; const ro1=new ResizeObserver(compute), ro2=new ResizeObserver(compute); ro1.observe(rp); ro2.observe(ll); compute(); const id=requestAnimationFrame(compute); return()=>{ ro1.disconnect(); ro2.disconnect(); cancelAnimationFrame(id); }; }, []);

  // Width for fit zoom
  const [panelWidth,setPanelWidth]=useState(1200);
  useEffect(()=>{const panel=rightPanelRef.current;if(!panel)return;const update=()=>setPanelWidth(panel.clientWidth||1200);update();const ro=new ResizeObserver(update);ro.observe(panel);return()=>ro.disconnect()},[]);

  // Timeline math
  const projectStartDate=parseYMD(settings.projectStart)||parseYMD('2025-10-01');
  const projectEndDate=parseYMD(settings.projectEnd)||parseYMD('2025-12-31');
  const totalDays=Math.max(1,daysBetween(projectStartDate,projectEndDate)+1);
  const fitPxPerDay=Math.max(1,Math.floor((panelWidth-200)/totalDays));
  const sliderMax=48; const sliderMin=Math.max(1,Math.min(fitPxPerDay,sliderMax));
  useEffect(()=>{setSettings(s=>s.dayWidth<fitPxPerDay?{...s,dayWidth:Math.min(Math.max(fitPxPerDay,1),sliderMax)}:s)},[fitPxPerDay]);
  const dayWidth=settings.dayWidth; const chartWidth=totalDays*dayWidth;

  function xForDate(d){if(!d)return null;const dd=parseYMD(d);if(!dd)return null;const delta=clamp(daysBetween(projectStartDate,dd),0,totalDays-1);return delta*dayWidth}
  function widthForRange(a,b){if(!a||!b)return 0;const s=parseYMD(a),e=parseYMD(b);if(!s||!e)return 0;const cs=daysBetween(projectStartDate,s);const ce=daysBetween(projectStartDate,e);const wd=clamp(ce-cs+1,0,totalDays);return wd*dayWidth}

  const visibleEpics=useMemo(()=>epics.filter(e=>!e.hidden),[epics]);
  const hiddenEpics=useMemo(()=>epics.filter(e=>e.hidden),[epics]);

  useEffect(()=>{localStorage.setItem('ep_title',title)},[title]);
  useEffect(()=>{localStorage.setItem('ep_data',JSON.stringify(epics))},[epics]);
  useEffect(()=>{localStorage.setItem('ep_settings',JSON.stringify(settings))},[settings]);

  const prevDayWidthRef=useRef(dayWidth);
  useEffect(()=>{const panel=rightPanelRef.current;if(!panel)return;const oldW=prevDayWidthRef.current,newW=dayWidth;if(oldW===newW)return;const prevW=totalDays*oldW,newWc=totalDays*newW;const prevCenter=panel.scrollLeft+panel.clientWidth/2;const ratio=prevCenter/Math.max(prevW,1);const newCenter=ratio*newWc;panel.scrollLeft=Math.max(0,newCenter-panel.clientWidth/2);prevDayWidthRef.current=newW},[dayWidth,totalDays]);

  useEffect(()=>{if(!settings.showToday)return;const tx=xForDate(fmtYMD(new Date()));const panel=rightPanelRef.current;if(tx!=null&&panel){panel.scrollLeft=Math.max(0,tx-200)}},[]);

  // CRUD
  function addEpic(epic){setEpics(prev=>[...prev,{id:uid(),...epic}])}
  function updateEpic(id,patch){setEpics(prev=>prev.map(e=>e.id===id?{...e,...patch}:e))}
  function removeEpic(id){setEpics(prev=>prev.filter(e=>e.id!==id))}
  function hideEpic(id){setEpics(prev=>prev.map(e=>e.id===id?{...e,hidden:true}:e))}
  function unhideEpic(id){setEpics(prev=>prev.map(e=>e.id===id?{...e,hidden:false}:e))}

  // IO helpers
  function download(filename,text,type='application/json'){const blob=new Blob([text],{type});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=filename;a.click();setTimeout(()=>URL.revokeObjectURL(url),500)}
  function exportJSON(){download('epic-plan.json',JSON.stringify({title,settings,epics},null,2))}
  function importJSON(file){const reader=new FileReader();reader.onload=()=>{try{const data=JSON.parse(reader.result);
    // Accept both old (top-level) and new (settings) shapes
    if(data.title) setTitle(data.title);
    const s = data.settings || data; // map top-level keys too
    const mapped={};
    if(s.projectStart) mapped.projectStart=s.projectStart;
    if(s.projectEnd)   mapped.projectEnd=s.projectEnd;
    if(s.sprintWeeks!=null) mapped.sprintWeeks=Number(s.sprintWeeks);
    if(s.showToday!=null)   mapped.showToday=!!s.showToday;
    if(s.dayWidth!=null)    mapped.dayWidth=Number(s.dayWidth);
    if(s.priorityColors||s.prioColors){ mapped.priorityColors = s.priorityColors || s.prioColors; }
    if(s.overlayColor)  mapped.overlayColor=s.overlayColor;
    if(s.overlayAlpha!=null) mapped.overlayAlpha=Number(s.overlayAlpha);
    if(s.completionOverlayColor) mapped.completionOverlayColor=s.completionOverlayColor;
    if(s.completionOverlayAlpha!=null) mapped.completionOverlayAlpha=Number(s.completionOverlayAlpha);
    if(s.etaColor) mapped.etaColor=s.etaColor;
    if(s.percentTextColor) mapped.percentTextColor=s.percentTextColor;
    if(s.showGuides!=null) mapped.showGuides=!!s.showGuides;
    if(s.rowHeight||s.rowH) mapped.rowHeight=Number(s.rowHeight||s.rowH);
    if(s.linkLabelFont!=null || s.linkFonts!=null) mapped.linkLabelFont=!!(s.linkLabelFont!=null?s.linkLabelFont:s.linkFonts);
    if(Object.keys(mapped).length) setSettings(v=>({...v,...mapped}));
    if(Array.isArray(data.epics)) setEpics(data.epics);
    // kick a parity pass after import
    setTimeout(()=>runParity(),0);
  }catch(e){alert('Invalid JSON file.')}};reader.readAsText(file)}
  function exportCSV(){const headers=['Epic Key','Epic Summary','Priority','Planned Start','Planned End','Actual Start','Actual End','Percent Complete','ETA'];const rows=[headers];epics.forEach(e=>rows.push([e.key,e.summary,e.priority,e.plannedStart,e.plannedEnd,e.actualStart||'',e.actualEnd||'',e.percentComplete,e.eta||'' ]));download('epic-plan.csv',toCSV(rows),'text/csv')}
  
  // --- helper: normalize common date formats to YYYY-MM-DD ---
  function normalizeDate(s){
    if(!s) return '';
    const t = String(s).trim(); if(!t) return '';
    if(/^\d{4}-\d{2}-\d{2}$/.test(t)) return t; // ISO
    let m = t.match(/^(\d{1,2})[-\/](\d{1,2})[-\/](\d{4})$/); // dd-mm-yyyy
    if(m){ const dd=m[1].padStart(2,'0'), mm=m[2].padStart(2,'0'), yyyy=m[3]; return `${yyyy}-${mm}-${dd}`; }
    m = t.match(/^(\d{1,2})[-\s]([A-Za-z]{3})[-\s](\d{4})$/); // dd-MMM-yyyy
    if(m){ const months={jan:'01',feb:'02',mar:'03',apr:'04',may:'05',jun:'06',jul:'07',aug:'08',sep:'09',oct:'10',nov:'11',dec:'12'}; const dd=m[1].padStart(2,'0'); const mon=(months[m[2].toLowerCase()]||'01'); const yyyy=m[3]; return `${yyyy}-${mon}-${dd}`; }
    try{ const d=new Date(t); if(!isNaN(d)) return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }catch(e){}
    return t;
  }
function bulkSyncCSV(file){const reader=new FileReader();reader.onload=()=>{const rows=parseCSV(reader.result).filter(r=>r.some(c=>c&&c.trim().length));if(rows.length<2){alert('CSV must include header and at least one row.');return;}const header=rows[0].map(h=>h.trim().toLowerCase());const req=['epic key','epic summary','priority','planned start','planned end','actual start','actual end','percent complete','eta'];for(const h of req){if(!header.includes(h)){alert('Missing required column: '+h);return;}}const idx=Object.fromEntries(req.map(h=>[h,header.indexOf(h)]));const incoming=rows.slice(1).map(r=>({key:r[idx['epic key']]?.trim(),summary:r[idx['epic summary']]?.trim(),priority:r[idx['priority']]?.trim(),plannedStart:normalizeDate(r[idx['planned start']]?.trim()),plannedEnd:normalizeDate(r[idx['planned end']]?.trim()),actualStart:normalizeDate((r[idx['actual start']]||'').trim()),actualEnd:normalizeDate((r[idx['actual end']]||'').trim()),percentComplete:Number(r[idx['percent complete']]||0),eta:normalizeDate((r[idx['eta']]||'').trim()),hidden:false,})).filter(x=>x.key&&x.summary&&x.priority && (x.plannedStart||x.plannedEnd||x.actualStart||x.actualEnd||x.eta));incoming.forEach(x=>{if(!['High','Medium','Low'].includes(x.priority))x.priority='Low'});const byKeyIncoming=new Map(incoming.map(e=>[e.key,e]));const byKeyExisting=new Map(epics.map(e=>[e.key,e]));const next=[];for(const [key,row] of byKeyIncoming.entries()){const existing=byKeyExisting.get(key);if(existing)next.push({...existing,...row,id:existing.id});else next.push({id:uid(),...row});}setEpics(next); setTimeout(()=>runParity(),0)};reader.readAsText(file)}
  function setPriorityColor(p,color){setSettings(s=>({...s,priorityColors:{...s.priorityColors,[p]:color}}))}

  // Row metrics & spacers
  const rowHeight=Number(settings.rowHeight)||36; const rowGap=parseInt(getComputedStyle(document.documentElement).getPropertyValue('--row-gap'))||8; const rowPitch=rowHeight+rowGap; const internalTopInset=40; const svgBottomExtra=20;
  const [spacers,setSpacers]=useState({top:0,bottom:0});

  useLayoutEffect(()=>{
  const labels=sprintLabelsRef.current; const canvas=rightCanvasRef.current; const left=leftListRef.current; const legend=legendRef.current; if(!labels||!canvas||!left||!legend) return;
  const cs=getComputedStyle(canvas), ls=getComputedStyle(left);
  const labelsH=(labels.offsetHeight||0); const legendH=(legend.offsetHeight||0);
  const rPadTop=parseInt(cs.paddingTop)||0; const rPadBottom=parseInt(cs.paddingBottom)||0;
  const leftPadTop=parseInt(ls.paddingTop)||0; const leftPadBottom=parseInt(ls.paddingBottom)||0;
  const rowPitch=rowHeight+rowGap;
  const contentHeightLocal = visibleEpics.length * rowPitch + 24;
  const rowsHeight = visibleEpics.length * rowPitch;
  const rightTotal = labelsH + rPadTop + internalTopInset + contentHeightLocal + rPadBottom + svgBottomExtra;
  const leftFixed  = legendH + leftPadTop + rowsHeight + leftPadBottom;
  const topSpacer = Math.max(0, (labelsH + rPadTop + internalTopInset) - (legendH + leftPadTop));
  const bottomSpacer = Math.max(0, rightTotal - (leftFixed + topSpacer));
  setSpacers({top:topSpacer,bottom:bottomSpacer});
},[visibleEpics.length,rowHeight,rowGap]);

  function runParity(){
    const rp=rightPanelRef.current, ll=leftListRef.current; if(!rp||!ll) return;
    let tries=0;
    const tick=()=>{ tries++; const rightTotal=rp.scrollHeight; const leftTotal=ll.scrollHeight; const delta=rightTotal-leftTotal; if(Math.abs(delta)>1){ setSpacers(prev=>({ ...prev, bottom: Math.max(0, prev.bottom + delta) })); }
      if(tries<3){ requestAnimationFrame(tick); }
    };
    requestAnimationFrame(tick);
  }

  // Parity shim triggers
  useLayoutEffect(runParity,[visibleEpics.length,rowHeight,rowGap,settings.dayWidth,settings.projectStart,settings.projectEnd,spacers.top]);
  useEffect(()=>{ window.addEventListener('load',runParity); window.addEventListener('resize',runParity); return()=>{window.removeEventListener('load',runParity); window.removeEventListener('resize',runParity);} },[]);

  const overlayRGBA=hexToRGBA(settings.overlayColor,clamp(settings.overlayAlpha,0,1));
  const completionOverlayRGBA=hexToRGBA(settings.completionOverlayColor,clamp(settings.completionOverlayAlpha,0,1));

  // Sprints
  const sprintWeeks=Number(settings.sprintWeeks)||2; const sprintDays=sprintWeeks*7; const sprints=[]; {let start=parseYMD(settings.projectStart)||new Date(); let i=1; while(start<=projectEndDate){const end=addDays(start,sprintDays-1); sprints.push({i,start,end}); start=addDays(start,sprintDays); i++; }}

  const contentHeight=visibleEpics.length*rowPitch+24;

  function EpicForm({initial,onCancel,onSave}){const [form,setForm]=useState(()=>initial||{key:'',summary:'',priority:'Medium',plannedStart:'',plannedEnd:'',actualStart:'',actualEnd:'',percentComplete:0,eta:''}); const bind=k=>({value:form[k]??'',onChange:e=>setForm(f=>({...f,[k]:e.target.value}))}); function submit(e){e.preventDefault(); onSave({...form,percentComplete:Number(form.percentComplete||0)})} return html`<div style=${{position:'fixed',inset:0,background:'rgba(0,0,0,0.5)',display:'grid',placeItems:'center',zIndex:50 }}><div style=${{width:620,background:'#0f1628',border:'1px solid var(--grid)',borderRadius:12 }}><div class="drawer-header"><div style=${{fontWeight:600 }}>${initial?'Edit Epic':'Add Epic'}</div><button class="small-btn" onClick=${onCancel}>Close</button></div><form onSubmit=${submit} style=${{padding:'12px',display:'grid',gap:'10px' }}><div class="row"><div><label>Epic Key</label><input required placeholder="EP-123" ...${bind('key')} /></div><div><label>Priority</label><select ...${bind('priority')}>${['High','Medium','Low'].map(p=>html`<option key=${p}>${p}</option>`)}</select></div></div><div><label>Epic Summary</label><input required placeholder="Summary" ...${bind('summary')} /></div><div class="row"><div><label>Planned Start</label><input type="date" ...${bind('plannedStart')} /></div><div><label>Planned End</label><input type="date" ...${bind('plannedEnd')} /></div></div><div class="row"><div><label>Actual Start</label><input type="date" ...${bind('actualStart')} /></div><div><label>Actual End</label><input type="date" ...${bind('actualEnd')} /></div></div><div class="row"><div><label>Percent Complete</label><input type="number" min="0" max="100" step="1" ...${bind('percentComplete')} /></div><div><label>ETA</label><input type="date" ...${bind('eta')} /></div></div><div style=${{display:'flex',gap:'8px',justifyContent:'flex-end' }}><button type="button" class="small-btn" onClick=${onCancel}>Cancel</button><button type="submit" class="small-btn">Save</button></div></form></div></div>`}

  // RENDER
  return html`<div class="app">
    <div class="topbar">
      <div class="title" contentEditable=${true} spellCheck=${false}
           onInput=${e=>setTitle(e.currentTarget.textContent||DEFAULT_TITLE)}
           onBlur=${e=>{ if(!(e.currentTarget.textContent||'').trim()){ e.currentTarget.textContent=title||DEFAULT_TITLE; setTitle(title||DEFAULT_TITLE);} }}
           onKeyDown=${e=>{ if(e.key==='Enter') e.preventDefault();  }}>${title}</div>

      <div class="toolbar">
        <button class="btn primary" onClick=${()=>setEditing({mode:'add'})}>+ Add Epic</button>
        <label style=${{display:'flex',alignItems:'center',gap:'6px' }}>
          <input type="checkbox" checked=${settings.showToday} onChange=${e=>setSettings(s=>({...s,showToday:e.target.checked}))} /> Today marker
        </label>
        <button class="btn" onClick=${()=>setDrawerOpen(v=>!v)}>${drawerOpen?'Hide Settings':'Settings'}</button>
      </div>

      <div class="toolbar">
        <div class="zoom-cluster">
          <button class="icon-btn" onClick=${()=>setSettings(s=>({...s,dayWidth:Math.max(sliderMin,s.dayWidth-2)}))}>–</button>
          <button class="icon-btn" onClick=${()=>setSettings(s=>({...s,dayWidth:Math.min(Math.max(fitPxPerDay,1),sliderMax)}))}>Fit</button>
          <button class="icon-btn" onClick=${()=>setSettings(s=>({...s,dayWidth:Math.min(sliderMax,s.dayWidth+2)}))}>+</button>
          <span class="zoom-readout">${dayWidth}px/day</span>
        </div>
        <button class="btn" onClick=${exportJSON}>Export JSON</button>
        <label class="btn" style=${{position:'relative',overflow:'hidden' }}>
          Import JSON
          <input type="file" accept="application/json" style=${{position:'absolute',inset:0,opacity:0,cursor:'pointer'}} onChange=${e=>{const f=e.target.files?.[0];if(f)importJSON(f);e.target.value='';}} />
        </label>
        <button class="btn" onClick=${exportCSV}>Export CSV</button>
        <label class="btn" style=${{position:'relative',overflow:'hidden' }}>
          Bulk CSV Sync
          <input type="file" accept=".csv,text/csv" style=${{position:'absolute',inset:0,opacity:0,cursor:'pointer'}} onChange=${e=>{const f=e.target.files?.[0];if(f)bulkSyncCSV(f);e.target.value='';}} />
        </label>
      </div>

      <div class="toolbar">
        <button class="btn" title="Save to your browser" onClick=${()=>{ localStorage.setItem('ep_title',title); localStorage.setItem('ep_data',JSON.stringify(epics)); localStorage.setItem('ep_settings',JSON.stringify(settings)); showToast('Saved locally ✓'); }}>Save</button>
        <button class="btn" onClick=${()=>{ const t=localStorage.getItem('ep_title'); if(t) setTitle(t); const d=localStorage.getItem('ep_data'); if(d){ try{ setEpics(JSON.parse(d)); }catch(e){} } const s=localStorage.getItem('ep_settings'); if(s){ try{ setSettings(v=>({...v,...JSON.parse(s)})); }catch(e){} } showToast('Loaded ✓'); }}>Load</button>
        <button class="btn" onClick=${()=>setHiddenOpen(v=>!v)}>${hiddenOpen? 'Hide Hidden' : `Hidden (${hiddenEpics.length})`}</button>
      </div>
    </div>

    <div class="header-row">
      <div class="left-header">Epic</div>
      <div class="right-header">Timeline (Sprints: ${String(Number(settings.sprintWeeks)||2)}w) • ${settings.projectStart} → ${settings.projectEnd} • Zoom: ${dayWidth}px/day</div>
    </div>

    <div class="layout">
      <div class="left-panel">
        <div class="legend" ref=${legendRef}>
          <div><div class="swatch" style=${{background:settings.priorityColors.High}}></div><span>High</span></div>
          <div><div class="swatch" style=${{background:settings.priorityColors.Medium}}></div><span>Medium</span></div>
          <div><div class="swatch" style=${{background:settings.priorityColors.Low}}></div><span>Low</span></div>
          <div><div class="swatch" style=${{background:settings.overlayColor,opacity:settings.overlayAlpha}}></div><span>Actual overlay</span></div>
          <div><div class="swatch" style=${{background:settings.completionOverlayColor,opacity:settings.completionOverlayAlpha}}></div><span>% complete</span></div>
          <div><div class="diamond" style=${{background:settings.etaColor}}></div><span>ETA</span></div>
        </div>

        <div class="left-list" ref=${leftListRef}>
          <div class="left-top-spacer" style=${{height:spacers.top+'px'}}></div>
          ${visibleEpics.map(e=> html`<div class="epic-row" key=${e.id}>
            <button class="hide-btn" title="Hide epic" onClick=${()=>hideEpic(e.id)}>-</button>
            <div class="epic-key">${e.key}</div>
            <div class="epic-summary" title=${e.summary}>${e.summary}</div>
            <div class="context-actions">
              <button class="small-btn" onClick=${()=>setEditing({mode:'edit', epic:e})}>Edit</button>
              <button class="small-btn danger" onClick=${()=>window.confirm('Remove this epic?')&&removeEpic(e.id)}>Remove</button>
            </div>
          </div>`)}
          <div class="left-bottom-spacer" style=${{height:spacers.bottom+'px'}}></div>

          ${settings.showGuides && html`<div class="guides-overlay" aria-hidden="true">
            ${Array.from({length:visibleEpics.length},(_,i)=> html`<div key=${'gl'+i} class="guide-line" style=${{top:(spacers.top + i*rowPitch)+'px'}}></div>`)}
          </div>`}

          ${visibleEpics.length===0 && html`<div style=${{color:'var(--muted)',padding:'12px'}}>No visible epics. Add or unhide items.</div>`}
        </div>
      </div>

      <div class="right-panel" ref=${rightPanelRef}>
        <div class="sprint-labels" ref=${sprintLabelsRef}>
          ${html`<svg width=${chartWidth+200} height=${30}>
            ${sprints.map((s,i)=>{const xs=xForDate(fmtYMD(s.start));if(xs==null)return null;return html`<g key=${'sprlab'+i}>
              <text x=${xs+6} y=${12} fill="#8fa2c8" fontSize=${11}>
                <tspan x=${xs+6} dy=${0}>${'S'+s.i}</tspan>
                <tspan x=${xs+6} dy=${12}>${fmtDDMMM(s.start)}</tspan>
              </text>
            </g>`})}
          </svg>`}
        </div>

        <div class="right-canvas" ref=${rightCanvasRef}>
          ${html`<svg class="grid-svg" width=${chartWidth+200} height=${contentHeight+internalTopInset+svgBottomExtra}>
            ${Array.from({length:totalDays},(_,d)=>{const x=d*dayWidth+0.5;const isWeek=((d%7)===0);return html`<line key=${'g'+d} x1=${x} x2=${x} y1=${0} y2=${contentHeight+internalTopInset} stroke=${isWeek?'#23324b':'#1b2435'} strokeWidth=${isWeek?1.2:1} />`})}
            ${sprints.map((s,i)=>{const xs=xForDate(fmtYMD(s.start));if(xs==null)return null;return html`<g key=${'spr'+i}><line x1=${xs+0.5} x2=${xs+0.5} y1=${0} y2=${contentHeight+internalTopInset} stroke="#4f5b72" strokeDasharray="4 4" strokeWidth=${1} /></g>`})}
            ${settings.showToday && (()=>{const tx=xForDate(fmtYMD(new Date()));return (tx!=null&&tx>=0&&tx<=chartWidth)?html`<g><line x1=${tx+0.5} x2=${tx+0.5} y1=${0} y2=${contentHeight+internalTopInset} stroke="var(--today-color)" strokeWidth=${2} /></g>`:null})()}
            ${settings.showGuides && Array.from({length:visibleEpics.length},(_,i)=> html`<line key=${'hl'+i} x1=${0} x2=${chartWidth+200} y1=${internalTopInset + i*rowPitch + 0.5} y2=${internalTopInset + i*rowPitch + 0.5} stroke="#2a3450" strokeDasharray="4 4" opacity="0.5" />`)}
            ${visibleEpics.map((e,idx)=>{const y=internalTopInset+idx*rowPitch;const c=settings.priorityColors[e.priority]||'#57c9a5';const px=xForDate(e.plannedStart);let pw=widthForRange(e.plannedStart,e.plannedEnd);const ax=xForDate(e.actualStart);const aw=widthForRange(e.actualStart,e.actualEnd);const etaX=xForDate(e.eta);const pct=clamp(Number(e.percentComplete)||0,0,100);const pctW=pw>0?Math.round(pw*(pct/100)):0;const barRadius=6;const minW=6;if(pw>0&&pw<minW)pw=minW;let labelX=null,labelText=`${Math.round(Number(e.percentComplete)||0)}%`;if(px!=null&&pw>12)labelX=px+pw/2;else if(ax!=null&&aw>12)labelX=ax+aw/2;const yCenter=y+(rowHeight-10)/2;const peX=xForDate(e.plannedEnd);const aeX=xForDate(e.actualEnd);return html`<g key=${e.id} onMouseEnter=${()=>setHoveredEpicId(e.id)} onMouseLeave=${()=>setHoveredEpicId(null)}>
  <!-- Hover runway to keep actions visible while moving mouse to the right -->
  ${html`<rect x=${0} y=${y-2} width=${chartWidth+200} height=${rowHeight} fill="rgba(0,0,0,0)" pointer-events="all" />`}

  ${px!=null && pw>0 && html`<rect x=${px} y=${y} width=${pw} height=${rowHeight-10} rx=${barRadius} fill=${c} fillOpacity=${0.95} stroke="#0c0f18" strokeWidth=${1}></rect>`}
  ${px!=null && pctW>0 && html`<rect x=${px} y=${y} width=${pctW} height=${rowHeight-10} rx=${barRadius} fill=${completionOverlayRGBA}></rect>`}
  ${ax!=null && aw>0 && html`<rect x=${ax} y=${y} width=${aw} height=${rowHeight-10} rx=${barRadius} fill=${overlayRGBA}></rect>`}

  ${labelX!=null && html`<text x=${labelX} y=${y+(rowHeight-10)/2+4} fontSize=${12} textAnchor="middle" fill=${settings.percentTextColor} fontWeight=${600}>${labelText}</text>`}

  ${etaX!=null && html`<g transform=${`translate(${etaX}, ${yCenter})`}>
      <rect x=${-6} y=${-6} width=${12} height=${12} transform="rotate(45)" fill=${settings.etaColor} stroke="#0d1322" strokeWidth=${1}></rect>
      <title>ETA: ${fmtDDMMM(parseYMD(e.eta))}</title>
    </g>`}

  <!-- Milestone dots with tooltips -->
  ${px!=null && html`<g>
      <circle cx=${px} cy=${yCenter} r=${3} fill="#0f1628" stroke=${c} strokeWidth=${1.6}></circle>
      <title>Planned Start: ${fmtDDMMM(parseYMD(e.plannedStart))}</title>
    </g>`}
  ${peX!=null && html`<g>
      <circle cx=${peX} cy=${yCenter} r=${3} fill="#0f1628" stroke=${c} strokeWidth=${1.6}></circle>
      <title>Planned End: ${fmtDDMMM(parseYMD(e.plannedEnd))}</title>
    </g>`}
  ${ax!=null && html`<g>
      <circle cx=${ax} cy=${yCenter} r=${3} fill="#0f1628" stroke=${settings.overlayColor} strokeWidth=${1.6}></circle>
      <title>Actual Start: ${fmtDDMMM(parseYMD(e.actualStart))}</title>
    </g>`}
  ${aeX!=null && html`<g>
      <circle cx=${aeX} cy=${yCenter} r=${3} fill="#0f1628" stroke=${settings.overlayColor} strokeWidth=${1.6}></circle>
      <title>Actual End: ${fmtDDMMM(parseYMD(e.actualEnd))}</title>
    </g>`}

  ${isDone(e) && html`<foreignObject x=${(px||0)+(pw||0)+6} y=${y-2} width=${64} height=${20}><div class="done-badge">✓ Done</div></foreignObject>`}

  ${hoveredEpicId===e.id && html`<foreignObject x=${Math.max(0, vpRight)} y=${y-2} width=${170} height=${rowHeight} style=${{overflow:'visible'}}>
      <div class="context-actions right">
        <button class="act-btn edit" onClick=${()=>setEditing({mode:'edit', epic:e})}>
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"/></svg>
          <span>Edit</span>
        </button>
        <button class="act-btn remove" onClick=${()=>window.confirm('Remove this epic?')&&removeEpic(e.id)}>
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M9 6V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"/></svg>
          <span>Remove</span>
        </button>
      </div>
    </foreignObject>`}
</g>`})}</svg>`}
        </div>
      </div>
    </div>

    ${drawerOpen && html`<div class="settings-drawer" role="dialog" aria-modal="true"><div class="backdrop" onClick=${()=>setDrawerOpen(false)}></div><div class="settings-sheet" role="document"><div class="drawer-header"><div style=${{fontWeight:600}}>Settings</div><button class="small-btn" onClick=${()=>setDrawerOpen(false)}>Close</button></div><div class="drawer-body">
      <div class="row"><div><label>Project Start</label><input type="date" value=${settings.projectStart} onChange=${e=>setSettings(s=>({...s,projectStart:e.target.value}))} /></div><div><label>Project End</label><input type="date" value=${settings.projectEnd} onChange=${e=>setSettings(s=>({...s,projectEnd:e.target.value}))} /></div></div>
      <div class="row"><div><label>Sprint length (weeks)</label><input type="number" min=${1} max=${8} value=${settings.sprintWeeks} onChange=${e=>setSettings(s=>({...s,sprintWeeks:Number(e.target.value||2)}))} /></div><div><label>Zoom (px/day)</label><input class="zoom-input" type="range" min=${sliderMin} max=${sliderMax} step=${1} value=${dayWidth} onChange=${e=>setSettings(s=>({...s,dayWidth:Number(e.target.value)}))} /><div style=${{fontSize:'11px',color:'#9aa4b2'}}>Range: ${sliderMin}–${sliderMax} px/day</div></div></div>
      <div style=${{borderTop:'1px dashed var(--grid)',paddingTop:'8px',marginTop:'4px',fontWeight:600,color:'#c7d2e1'}}>Colors & Guides</div>
      <div class="row-3"><div><label>High</label><input type="color" value=${settings.priorityColors.High} onChange=${e=>setPriorityColor('High',e.target.value)} /></div><div><label>Medium</label><input type="color" value=${settings.priorityColors.Medium} onChange=${e=>setPriorityColor('Medium',e.target.value)} /></div><div><label>Low</label><input type="color" value=${settings.priorityColors.Low} onChange=${e=>setPriorityColor('Low',e.target.value)} /></div></div>
      <div class="row"><div><label>Actual overlay</label><input type="color" value=${settings.overlayColor} onChange=${e=>setSettings(s=>({...s,overlayColor:e.target.value}))} /></div><div><label>Overlay opacity</label><input type="range" min=${0.05} max=${0.95} step=${0.05} value=${settings.overlayAlpha} onChange=${e=>setSettings(s=>({...s,overlayAlpha:Number(e.target.value)}))} /></div></div>
      <div class="row"><div><label>% complete overlay</label><input type="color" value=${settings.completionOverlayColor} onChange=${e=>setSettings(s=>({...s,completionOverlayColor:e.target.value}))} /></div><div><label>% complete opacity</label><input type="range" min=${0.05} max=${0.95} step=${0.05} value=${settings.completionOverlayAlpha} onChange=${e=>setSettings(s=>({...s,completionOverlayAlpha:Number(e.target.value)}))} /></div></div>
      <div class="row"><div><label>ETA diamond</label><input type="color" value=${settings.etaColor} onChange=${e=>setSettings(s=>({...s,etaColor:e.target.value}))} /></div><div><label>% text color</label><input type="color" value=${settings.percentTextColor} onChange=${e=>setSettings(s=>({...s,percentTextColor:e.target.value}))} /></div></div>
      <div class="row"><div><label>Row height (px)</label><input type="range" min=${24} max=${80} step=${2} value=${rowHeight} onChange=${e=>setSettings(s=>({...s,rowHeight:Number(e.target.value)}))} /><div style=${{fontSize:'11px',color:'#9aa4b2'}}>Current: ${rowHeight}px</div></div><div style=${{display:'flex',alignItems:'center',gap:'6px'}}><input type="checkbox" checked=${settings.linkLabelFont} onChange=${e=>setSettings(s=>({...s,linkLabelFont:e.target.checked}))} /><label>Link label font to row height</label></div></div>
      <div class="row"><div style=${{display:'flex',alignItems:'center',gap:'6px'}}><input type="checkbox" checked=${settings.showGuides} onChange=${e=>setSettings(s=>({...s,showGuides:e.target.checked}))} /><label>Show alignment guides</label></div><div></div></div>
    </div></div></div>`}

    ${hiddenOpen && html`
  <div className="hidden-drawer" role="dialog" aria-modal="true">
    <div className="backdrop" onClick=${()=>setHiddenOpen(false)}></div>
    <div className="hidden-sheet" role="document">
      <div class="drawer-header">
        <div style=${{fontWeight:600}}>Hidden Epics (${hiddenEpics.length})</div>
        <button class="small-btn" onClick=${()=>setHiddenOpen(false)}>Close</button>
      </div>
      <div class="drawer-body">
        ${hiddenEpics.map(e=> html`
          <div class="hidden-item" key=${e.id}>
            <div><strong>${e.key}</strong> — ${e.summary}</div>
            <button class="small-btn" onClick=${()=>unhideEpic(e.id)}>Unhide</button>
          </div>
        `)}
        ${hiddenEpics.length===0 && html`
          <div style=${{padding:'10px',color:'var(--muted)'}}>No hidden epics.</div>
        `}
      </div>
    </div>
  </div>
`}

    ${editing && html`<${EpicForm} initial=${editing.mode==='edit'?editing.epic:null} onCancel=${()=>setEditing(null)} onSave=${data=>{ if(editing.mode==='edit') updateEpic(editing.epic.id,data); else addEpic(data); setEditing(null); }} />`}
    ${toast && html`<div class="toast" role="status">${toast}</div>`}
  </div>`;
}

ReactDOM.createRoot(document.getElementById('root')).render(html`<${App} />`);
</script>
<script>
function formatDateDDMMM(dateStr) {
  const date = new Date(dateStr);
  return date.toLocaleDateString('en-GB', { day: '2-digit', month: 'short' });
}

document.querySelectorAll('.epic-label').forEach(label => {
  label.addEventListener('mouseenter', () => {
    const leftPane = document.querySelector('.left-pane-actions');
    if (leftPane) leftPane.style.display = 'none';
    const rightActions = label.closest('.gantt-row')?.querySelector('.contextual-actions');
    if (rightActions) rightActions.style.display = 'block';
  });
});

document.querySelectorAll('.date-marker').forEach(marker => {
  const dateType = marker.dataset.type;
  const dateValue = marker.dataset.date;
  if (dateValue) {
    marker.title = `${dateType.toUpperCase()}: ${formatDateDDMMM(dateValue)}`;
  }
});
</script></body>
</html>